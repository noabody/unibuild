#!/bin/bash

spth="$(realpath "$HOME/.config/unity3d/Daggerfall Workshop/Daggerfall Unity/Saves")"
# default engine local config path
i_pths=()
npth="${@:1}"
# pull all command line objects in as single path
test -d "$npth" && spth="$(realpath "$npth")"
# if path provided on cmdline, use it
readarray -t i_pths < <(find -H "$spth" -maxdepth 3 -type f -iname 'savedata.txt' -printf '%h\n' 2>/dev/null | sort)
# find the save games

IFS=$'\n'
if [[ ${#i_pths[@]} -gt 0 ]]; then
  for save in ${i_pths[@]}; do
    plyr=$(grep -Pi 'currenthealth' "$save/SaveData.txt" |wc -l)
    if [[ $plyr -gt 1 ]]; then
      echo -e "  $save/SaveData.txt:\n      contains enemy data. Updating would create super enemies.\n      Save with no enemies nearby and retry.\n"
    elif [[ $plyr -eq 1 ]]; then
      perl -pi -e 's#(\"AdvancementMultiplier\":) [\d\.]+#\1 0.1#gi ; s#(\"HitPointsPerLevel\":) \d+#\1 0#gi ; s#(\"(Paralysis|Magic|Poison|Fire|Frost|Shock|Disease)\": \").*(?=\")#\1Immune#gi ; s#(\"(ShortBlades|LongBlades|HandToHand|Axes|BluntWeapons|MissileWeapons)\": \").*(?=\")#\1Expert#gi ; s#(\"(UndeadAttackModifier|DaedraAttackModifier|HumanoidAttackModifier|AnimalsAttackModifier)\": \").*(?=\")#\1Bonus#gi ; s#(\"SpellPointMultiplier\": \").*(?=\")#\1Times_3_00#gi ; s#(\"SpellPointMultiplierValue\":) [\d\.]+#\1 3.0#gi ; s#(\"(AcuteHearing|Athleticism|AdrenalineRush)\": ).*(?=,)#\1true#gi ; s#(\"(Regeneration|RapidHealing)\": \").*(?=\")#\1Always#gi ; s#(\"(Strength|Intelligence|Willpower|Agility|Endurance|Personality|Speed|Luck|Medical|Etiquette|Streetwise|Jumping|Orcish|Harpy|Giantish|Dragonish|Nymph|Daedric|Spriggan|Centaurian|Impish|Lockpicking|Mercantile|Pickpocket|Stealth|Swimming|Climbing|Backstabbing|Dodging|Running|Destruction|Restoration|Illusion|Alteration|Thaumaturgy|Mysticism|ShortBlade|LongBlade|HandToHand|Axe|BluntWeapon|Archery|CriticalStrike|reputation\w+)\":) \d+#\1 100#gi ; s#(\"(maxHealth|currentHealth|hits[12])\":) \d+#\1 999999#gi ; s#(\"currentFatigue\":) \d+#\1 12800#gi ; s#(\"currentMagicka\":) \d+#\1 300#gi ; s#(\"goldPieces\":) \d+#\1 9999#gi ; s#(\"crimeCommitted\": \").*(?=\")#\1None#gi' "$save/SaveData.txt"
# no hp for levelup, all immunities, expert weapons, bonus attack modifiers, 3x spell points, unique abilities and regeneration except spellabsorption (can harm player), stats 100, max fatigue/magicka, health/degrade 999999, gold 9999, no crimes committed
# s#(\"(Fire|Frost|DiseaseOrPoison|Shock|Magic|level)\":) \d+#\1 1#gi
      perl -pi -e 's#(\"rep\":) \d+#\1 100#gi' "$save/FactionData.txt"
      echo -e "  $save/SaveData.txt:\n       sucessfully updated.\n"
    else
      echo -e "  $save/SaveData.txt:\n       is not a valid save file.\n"
    fi
  done
  unset i_pths IFS
else
  echo "No saves found in $spth."
fi
